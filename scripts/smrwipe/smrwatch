#!/usr/bin/env bash
# SPDX-FileCopyrightText: 2025 Mike Wilson
# SPDX-License-Identifier: GPL-3.0-or-later
#
# smrwatch - live SMR wipe monitoring TUI with progress bars
# Author: Mike Wilson <mike@mikewilsonstl.com>
# Created: 2025-12-15

set -euo pipefail
shopt -s nullglob

INTERVAL=1

# ANSI colors
RED="\033[1;31m"
YELLOW="\033[1;33m"
GREEN="\033[1;32m"
CYAN="\033[1;36m"
# BLUE="\033[1;34m"
RESET="\033[0m"

hide_cursor() { printf "\033[?25l"; }
show_cursor() { printf "\033[?25h"; }

cleanup() {
    show_cursor
    printf "\033[0m"
}

trap cleanup EXIT INT TERM

die() {
    echo "ERROR: $*" >&2
    exit 1
}

require_cgroup_v2() {
    [[ -f /sys/fs/cgroup/cgroup.controllers ]] || die "cgroup v2 not mounted"
    grep -qw io /sys/fs/cgroup/cgroup.controllers || die "IO controller not available"
}

resolve_cgroup() {
    PID=$(pgrep -n -f 'python3 main.py')
    [[ -n "$PID" ]] || die "smrwipe not running"

    SCOPE=$(grep smrwipe.scope /proc/"$PID"/cgroup | cut -d: -f3)
    [[ -n "$SCOPE" ]] || die "Unable to determine cgroup path"

    CG=/sys/fs/cgroup${SCOPE}
    [[ -d "$CG" ]] || die "cgroup path not found: $CG"

    echo "$CG"
}

color_value() {
    local val=$1 type=$2
    if [[ -z "$val" ]]; then
        echo -e "$RESET$val"
    elif (( $(echo "$val > 0.0" | bc -l) )); then
        if [[ "$type" == "full" ]]; then
            echo -e "${RED}$val${RESET}"
        else
            echo -e "${YELLOW}$val${RESET}"
        fi
    else
        echo -e "${GREEN}$val${RESET}"
    fi
}

draw_progress_bar() {
    local percent=$1 width=${2:-20}
    local filled=$(( percent * width / 100 ))
    local empty=$(( width - filled ))
    printf "["
    printf "%0.s#" $(seq 1 $filled)
    printf "%0.s-" $(seq 1 $empty)
    printf "] %3d%%" "$percent"
}

print_scope_pressure() {
    local cg=$1
    echo -e "${CYAN}== Scope IO Pressure ==${RESET}"

    if [[ -f "$cg/io.pressure" ]]; then
        while read -r line; do
            some=$(echo "$line" | awk '{print $1}' | cut -d= -f2)
            full=$(echo "$line" | awk '{print $2}' | cut -d= -f2)
            printf " some: %s full: %s\n" \
                "$(color_value "$some" some)" \
                "$(color_value "$full" full)"
        done < "$cg/io.pressure"
    else
        echo "(no io.pressure yet)"
    fi
    echo
}

print_workers() {
    local cg=$1
    if compgen -G "$cg/worker-*" > /dev/null; then
        printf "%-15s %-20s %-10s %-10s\n" "WORKER" "IO MAX" "PROGRESS" "STATUS"
        for d in "$cg"/worker-*; do
            worker=$(basename "$d")

            # io.max
            io_max="N/A"
            [[ -f "$d/io.max" ]] && io_max=$(head -n1 "$d/io.max")
            io_max=$(printf "%-18.18s" "$io_max")

            # get verify_percent from a file (Python could write to io.stat temporarily for demo)
            verify=0
            [[ -f "$d/io.stat" ]] && verify=$(grep -oP 'verify_percent=\K[0-9.]+' "$d/io.stat" || true)
            verify=${verify%.*}  # integer for progress bar

            # hash verification status (Python could write to a file in worker dir)
            status="UNKNOWN"
            [[ -f "$d/status" ]] && status=$(head -n1 "$d/status")
            case "$status" in
                PASS) status="${GREEN}PASS${RESET}" ;;
                FAIL) status="${RED}FAIL${RESET}" ;;
                *) status="${YELLOW}UNKNOWN${RESET}" ;;
            esac

            prog=$(draw_progress_bar "$verify" 20)

            printf "%-15s %-20s %-10s %-10s\n" "$worker" "$io_max" "$prog" "$status"
        done
    else
        echo "(no worker cgroups â€” running in single scope)"
    fi
    echo
}

clear_screen() {
    printf "\033[H"
}

main_loop() {
    local cg=$1
    while true; do
        clear_screen
        echo -e "${CYAN}SMR Wipe Monitoring Dashboard${RESET}"
        echo "============================="
        date
        echo

        print_scope_pressure "$cg"
        print_workers "$cg"

        sleep "$INTERVAL"
    done
}

main() {
    require_cgroup_v2
    CG=$(resolve_cgroup)
    echo "Monitoring cgroup: $CG"
    sleep 1
    printf "\033[2J"   # clear screen once
    hide_cursor
    main_loop "$CG"
}

main "$@"
